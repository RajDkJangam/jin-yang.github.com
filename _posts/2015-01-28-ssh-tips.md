---
title: SSH 杂项
layout: post
comments: true
language: chinese
usemath: true
category: [linux,misc]
keywords: ssh
description: 简单记录一些常见的 SSH 使用技巧。
---

简单记录一些常见的 SSH 使用技巧。

<!-- more -->

## 登陆禁止

有时候需要 SSH 登陆到别的 Linux 主机上去时，可能会弹出如下类似提示：

{% highlight text %}
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
... ...
Host key verification failed.
{% endhighlight %}

ssh 会把访问过的计算机公钥 (public key) 记录在 ~/.ssh/known_hosts，下次访问时，OpenSSH 会核对公钥，如果公钥不同，则会发出警告，避免受到 DNS Hijack 之类的攻击。

如果一台主机上有多个 Linux 系统，或者需要重新设置公钥，那么就需要手动删除 known_hosts 中相应的配置项。可以有两种方式解决：

{% highlight text %}
1. 手动删除修改 known_hosts 里相应的记录；

2. 修改配置文件 "~/.ssh/config"，加上这两行，重启服务器。
   StrictHostKeyChecking no
   UserKnownHostsFile /dev/null
{% endhighlight %}

后者安全性比较低。


## 双因子验证

Google 提供了简单的双因子验证程序，而且是开源的，详细可以参考手机端程序 [github auth](https://github.com/google/google-authenticator) 以及 ssh 服务端的 PAM 模块 [github libpam](https://github.com/google/google-authenticator-libpam) 。

手机端可以直接下载安装即可，在 CentOS 中，可以通过如下方式安装。

{% highlight text %}
----- 生成二维码的工具
# yum install qrencode

----- 安装PAM模块
# yum --enablerepo=epel install google-authenticator
{% endhighlight %}

然后直接通过 ```google-authenticator``` 命令配置即可，除了二维码，还会生成一堆类似如下的内容；可以直接通过手机扫描二维码即可，或者手动输入下面的 ```Secret Key```。

{% highlight text %}
Your new secret key is: XXXXXXXXXXXXXXXXXXXXXXXXXX
Your verification code is 666666
Your emergency scratch codes are:
  11111111
  22222222
  33333333
  44444444
  66666666
{% endhighlight %}

最终配置完成后，会在 HOME 目录下生成一个 ```.google_authenticator``` 文件，默认权限为 400 。

### 配置sshd

接下来需要确认如下内容。

{% highlight text %}
$ cat /etc/pam.d/sshd | grep 'pam_google_auth'
auth required pam_google_authenticator.so

$ cat /etc/ssh/sshd_config | grep 'ChallengeResponseAuthentication'
ChallengeResponseAuthentication yes

# systemctl restart sshd
{% endhighlight %}

然后，通过 ssh 登陆时，会有如下的提示内容。

{% highlight text %}
$ ssh 192.168.9.102
Verification code: 
Password: 
{% endhighlight %}


{% highlight text %}
{% endhighlight %}
